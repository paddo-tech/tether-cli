name: Release

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/release.yml'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Skip tag/release creation (test build only)'
        type: boolean
        default: false

permissions:
  contents: write

env:
  # Signing identity - must match certificate installed on runner
  SIGNING_IDENTITY: "Developer ID Application: Paddo Tech PTY LTD (D9Q57P9D3L)"

jobs:
  build:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Build release (Apple Silicon)
        run: cargo build --release --target aarch64-apple-darwin

      - name: Build release (Intel)
        run: cargo build --release --target x86_64-apple-darwin

      - name: Sign binaries
        run: |
          codesign --sign "$SIGNING_IDENTITY" \
            --options runtime \
            --timestamp \
            --force \
            target/aarch64-apple-darwin/release/tether

          codesign --sign "$SIGNING_IDENTITY" \
            --options runtime \
            --timestamp \
            --force \
            target/x86_64-apple-darwin/release/tether

      - name: Notarize binaries
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          # Notarize Apple Silicon binary
          cd target/aarch64-apple-darwin/release
          zip tether-arm64.zip tether
          xcrun notarytool submit tether-arm64.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait
          rm tether-arm64.zip
          cd -

          # Notarize Intel binary
          cd target/x86_64-apple-darwin/release
          zip tether-x64.zip tether
          xcrun notarytool submit tether-x64.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait
          rm tether-x64.zip

      - name: Package binaries
        run: |
          cd target/aarch64-apple-darwin/release
          tar -czf tether-aarch64-apple-darwin.tar.gz tether
          shasum -a 256 tether-aarch64-apple-darwin.tar.gz > tether-aarch64-apple-darwin.tar.gz.sha256
          cd -

          cd target/x86_64-apple-darwin/release
          tar -czf tether-x86_64-apple-darwin.tar.gz tether
          shasum -a 256 tether-x86_64-apple-darwin.tar.gz > tether-x86_64-apple-darwin.tar.gz.sha256

      - name: Get version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # Detect prerelease (contains -alpha, -beta, -rc)
          if [[ "$VERSION" =~ -alpha|-beta|-rc ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if tag exists
        id: tag_check
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/v${{ steps.version.outputs.version }}$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag v${{ steps.version.outputs.version }} already exists, skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create tag
        if: steps.tag_check.outputs.exists == 'false' && github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Create GitHub Release
        if: steps.tag_check.outputs.exists == 'false' && github.event.inputs.dry_run != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          prerelease: ${{ steps.version.outputs.prerelease == 'true' }}
          generate_release_notes: true
          files: |
            target/aarch64-apple-darwin/release/tether-aarch64-apple-darwin.tar.gz
            target/aarch64-apple-darwin/release/tether-aarch64-apple-darwin.tar.gz.sha256
            target/x86_64-apple-darwin/release/tether-x86_64-apple-darwin.tar.gz
            target/x86_64-apple-darwin/release/tether-x86_64-apple-darwin.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew formula
        if: steps.tag_check.outputs.exists == 'false' && github.event.inputs.dry_run != 'true'
        env:
          COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
          IS_PRERELEASE: ${{ steps.version.outputs.prerelease }}
        run: |
          SHA_ARM=$(cat target/aarch64-apple-darwin/release/tether-aarch64-apple-darwin.tar.gz.sha256 | awk '{print $1}')
          SHA_X86=$(cat target/x86_64-apple-darwin/release/tether-x86_64-apple-darwin.tar.gz.sha256 | awk '{print $1}')

          # Clone the tap repo
          rm -rf /tmp/homebrew-tap
          git clone https://x-access-token:${COMMITTER_TOKEN}@github.com/paddo-tech/homebrew-tap.git /tmp/homebrew-tap
          cd /tmp/homebrew-tap

          # Determine formula file and class name
          if [ "$IS_PRERELEASE" = "true" ]; then
            # Versioned formula for prereleases: tether-cli@1.1.0-beta.1.rb
            FORMULA_FILE="Formula/tether-cli@${VERSION}.rb"
            # Convert version to valid Ruby class name: 1.1.0-beta.1 -> 110Beta1
            # Remove dots, capitalize after hyphens, remove hyphens
            CLASS_NAME="TetherCliAT$(echo ${VERSION} | perl -pe 's/\.//g; s/-(.)/\u$1/g')"
          else
            # Main formula for stable releases
            FORMULA_FILE="Formula/tether-cli.rb"
            CLASS_NAME="TetherCli"
          fi

          # Generate formula
          printf '%s\n' \
            "class ${CLASS_NAME} < Formula" \
            '  desc "Sync dotfiles and packages across machines"' \
            '  homepage "https://github.com/paddo-tech/tether-cli"' \
            "  version \"${VERSION}\"" \
            '  license "MIT"' \
            '' \
            '  on_macos do' \
            '    on_intel do' \
            "      url \"https://github.com/paddo-tech/tether-cli/releases/download/v${VERSION}/tether-x86_64-apple-darwin.tar.gz\"" \
            "      sha256 \"${SHA_X86}\"" \
            '    end' \
            '    on_arm do' \
            "      url \"https://github.com/paddo-tech/tether-cli/releases/download/v${VERSION}/tether-aarch64-apple-darwin.tar.gz\"" \
            "      sha256 \"${SHA_ARM}\"" \
            '    end' \
            '  end' \
            '' \
            '  def install' \
            '    bin.install "tether"' \
            '  end' \
            '' \
            '  def caveats' \
            '    <<~EOS' \
            '      To get started, run:' \
            '        tether init' \
            '' \
            '      This will set up your sync repository and start the background daemon.' \
            '    EOS' \
            '  end' \
            '' \
            '  test do' \
            '    assert_match "tether", shell_output("#{bin}/tether --help")' \
            '  end' \
            'end' > "$FORMULA_FILE"

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$FORMULA_FILE"
          git commit -m "tether-cli ${VERSION}"
          git push

