---
interface Props {
  code: string;
  language?: string;
  showLineNumbers?: boolean;
  copyable?: boolean;
  stretch?: boolean;
}

const {
  code,
  language = 'bash',
  showLineNumbers = false,
  copyable = true,
  stretch = false,
} = Astro.props;

const lines = code.trim().split('\n');
const id = `code-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="relative group">
  {copyable && (
    <button
      class="absolute top-3 right-3 p-2 bg-surface hover:bg-primary/10 text-muted hover:text-primary rounded transition-all opacity-0 group-hover:opacity-100"
      data-copy-button
      data-code-id={id}
      aria-label="Copy code"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
      </svg>
      <span class="sr-only">Copy code</span>
    </button>
  )}

  <div class="bg-surface rounded-lg overflow-hidden border border-surface">
    <div class="flex items-center justify-between px-4 py-2 border-b border-background">
      <span class="text-xs font-mono text-muted uppercase">{language}</span>
    </div>
    <pre
      id={id}
      class="p-4 overflow-x-auto text-sm font-mono"
    ><code class="language-{language}">{showLineNumbers ? lines.map((line, i) => `${String(i + 1).padStart(2, ' ')} ${line}`).join('\n') : lines.map((line) => {
      const trimmed = line.trim();
      const isNotCommand = trimmed.startsWith('#') || trimmed.startsWith('✓') || trimmed.startsWith('ℹ') ||
        trimmed.startsWith('├') || trimmed.startsWith('└') || trimmed.startsWith('│') ||
        trimmed.startsWith('→') || trimmed === '' || /^[A-Za-z]/.test(trimmed) === false;
      return isNotCommand ? line : `$ ${line}`;
    }).join('\n')}
<span class="text-muted">$</span> <span class="inline-block w-2 h-4 bg-primary animate-pulse align-middle"></span></code></pre>
  </div>
</div>

<script>
  document.querySelectorAll('[data-copy-button]').forEach((button) => {
    button.addEventListener('click', async () => {
      const codeId = button.getAttribute('data-code-id');
      const codeElement = document.getElementById(codeId!);
      const code = codeElement?.textContent || '';

      try {
        await navigator.clipboard.writeText(code.trim());

        // Visual feedback
        const svg = button.querySelector('svg');
        const originalHTML = svg?.innerHTML;

        if (svg) {
          svg.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />`;
          setTimeout(() => {
            svg.innerHTML = originalHTML || '';
          }, 2000);
        }
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });
  });
</script>
