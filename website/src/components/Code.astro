---
interface Props {
  code: string;
  lang?: string;
}

const { code, lang = 'bash' } = Astro.props;
const id = `code-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="relative group my-4">
  <button
    class="absolute top-2 right-2 p-1.5 bg-background/50 hover:bg-primary/10 text-muted hover:text-primary rounded transition-all opacity-0 group-hover:opacity-100"
    data-copy-btn
    data-code-id={id}
    aria-label="Copy code"
  >
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
    </svg>
  </button>
  <pre id={id} class="bg-surface rounded-lg p-4 overflow-x-auto text-sm font-mono text-text border border-surface">{code.trim()}</pre>
</div>

<script>
  document.querySelectorAll('[data-copy-btn]').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-code-id');
      const el = document.getElementById(id!);
      const text = el?.textContent || '';

      try {
        await navigator.clipboard.writeText(text.trim());
        const svg = btn.querySelector('svg');
        const orig = svg?.innerHTML;
        if (svg) {
          svg.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />`;
          setTimeout(() => { svg.innerHTML = orig || ''; }, 2000);
        }
      } catch (e) {
        console.error('Copy failed:', e);
      }
    });
  });
</script>
