---
import DocsLayout from '../../layouts/DocsLayout.astro';
import Code from '../../components/Code.astro';
---

<DocsLayout
  title="Documentation - Tether CLI"
  description="Complete documentation for Tether CLI"
>
  <!-- Introduction -->
  <section id="introduction">
    <h1>Tether CLI Documentation</h1>
    <p>
      Tether is an open source tool that automatically syncs your development environment—dotfiles and packages—across multiple machines with end-to-end encryption.
    </p>
    <h3>Key Features</h3>
    <ul>
      <li><strong>Automatic Sync</strong> — Background daemon watches for changes and syncs in real-time</li>
      <li><strong>End-to-End Encryption</strong> — AES-256-GCM encryption with passphrase-protected keys</li>
      <li><strong>Project Configs</strong> — Sync .env files and IDE settings across machines by Git remote</li>
      <li><strong>Package Manager Support</strong> — Syncs Homebrew, npm, pnpm, bun, and gem packages</li>
      <li><strong>Secret Detection</strong> — Prevents accidental syncing of API keys and credentials</li>
      <li><strong>Git-Backed</strong> — Full version history and rollback capabilities</li>
      <li><strong>Team Secrets</strong> — Share encrypted secrets across teams with age encryption</li>
    </ul>
  </section>

  <hr class="my-12 border-surface" />

  <!-- Installation -->
  <section id="installation">
    <h2>Installation</h2>
    <h3>Homebrew (recommended)</h3>
    <Code code={`brew tap paddo-tech/tap
brew install tether-cli`} />
    <h3>Requirements</h3>
    <ul>
      <li><strong>Platform:</strong> macOS (Linux coming soon)</li>
      <li><strong>Shell:</strong> zsh or bash</li>
      <li><strong>Git:</strong> Configured with GitHub, GitLab, or self-hosted Git server</li>
    </ul>
  </section>

  <hr class="my-12 border-surface" />

  <!-- Quick Start -->
  <section id="quick-start">
    <h2>Quick Start</h2>
    <p>Get up and running in under a minute:</p>
    <h3>1. Initialize</h3>
    <Code code="tether init" />
    <p>Follow the prompts to configure your Git repository and encryption passphrase.</p>
    <h3>2. Verify Setup</h3>
    <Code code="tether status" />
    <p>You should see the daemon running and your synced files listed.</p>
    <h3>3. On Another Machine</h3>
    <Code code={`brew tap paddo-tech/tap && brew install tether-cli
tether init --repo git@github.com:username/dotfiles.git`} />
    <p>Enter the same passphrase. Your configs sync automatically.</p>
  </section>

  <hr class="my-12 border-surface" />

  <!-- How It Works -->
  <section id="how-it-works">
    <h2>How It Works</h2>
    <h3>Architecture</h3>
    <p>
      Tether uses a Git repository as the sync backend. When you make changes to dotfiles or install packages, the background daemon detects these changes, encrypts your dotfiles with AES-256-GCM, and pushes them to your private Git repository.
    </p>
    <p>
      On your other machines, Tether pulls these changes and applies them automatically.
    </p>
    <h3>Sync Flow</h3>
    <ol>
      <li>Daemon detects file changes (every 5 minutes or manual <code>tether sync</code>)</li>
      <li>Secret scanner checks for credentials</li>
      <li>Files are encrypted (if enabled)</li>
      <li>Changes committed and pushed to Git</li>
      <li>Other machines pull and decrypt</li>
    </ol>
    <h3>Data Layout</h3>
    <p>Local Tether data lives in <code>~/.tether/</code>:</p>
    <Code code={`~/.tether/
├── config.toml      # Configuration (versioned)
├── state.json       # Sync state (hashes, timestamps)
├── sync/            # Personal sync repo
├── teams/<name>/    # Team sync repos
├── collabs/         # Collab project configs
├── backups/         # File backups
├── identity.pub     # Age public key (for team secrets)
├── daemon.pid       # Daemon process ID
├── daemon.log       # Daemon logs
└── conflicts.json   # Conflict state`} />
    <p>The sync repository structure:</p>
    <Code code={`sync/
├── dotfiles/        # Encrypted dotfiles
├── configs/         # Config directories
├── projects/        # Project-local configs
├── manifests/       # Package manifests
└── machines/        # Per-machine state`} />
  </section>

  <hr class="my-12 border-surface" />

  <!-- Commands -->
  <section id="commands">
    <h2>Commands</h2>

    <h3 id="cmd-init">tether init</h3>
    <p>Initialize Tether on this machine.</p>
    <Code code="tether init [--repo <URL>] [--no-daemon]" />
    <ul>
      <li><code>--repo &lt;URL&gt;</code> — Git repository URL (interactive if omitted)</li>
      <li><code>--no-daemon</code> — Don't start daemon after init</li>
    </ul>

    <h3 id="cmd-sync">tether sync</h3>
    <p>Manually trigger a sync.</p>
    <Code code="tether sync [--dry-run] [--force]" />
    <ul>
      <li><code>--dry-run</code> — Show what would be synced</li>
      <li><code>--force</code> — Skip conflict prompts</li>
    </ul>

    <h3 id="cmd-status">tether status</h3>
    <p>Show current sync status, daemon state, and synced files.</p>
    <Code code="tether status" />

    <h3 id="cmd-diff">tether diff</h3>
    <p>Show differences between machines.</p>
    <Code code="tether diff [--machine <NAME>]" />
    <ul>
      <li><code>--machine &lt;NAME&gt;</code> — Compare with specific machine</li>
    </ul>

    <h3 id="cmd-daemon">tether daemon</h3>
    <p>Control the background daemon.</p>
    <Code code="tether daemon <start|stop|restart|logs|install|uninstall>" />
    <ul>
      <li><code>start</code> — Start the daemon</li>
      <li><code>stop</code> — Stop the daemon</li>
      <li><code>restart</code> — Restart the daemon</li>
      <li><code>logs</code> — View last 50 log lines</li>
      <li><code>install</code> — Install launchd service (auto-start on login)</li>
      <li><code>uninstall</code> — Remove launchd service</li>
    </ul>

    <h3 id="cmd-machines">tether machines</h3>
    <p>Manage machines in sync network.</p>
    <Code code="tether machines <list|rename|remove>" />
    <ul>
      <li><code>list</code> — List all machines</li>
      <li><code>rename &lt;OLD&gt; &lt;NEW&gt;</code> — Rename a machine</li>
      <li><code>remove &lt;NAME&gt;</code> — Remove a machine</li>
    </ul>

    <h3 id="cmd-ignore">tether ignore</h3>
    <p>Manage ignore patterns and per-machine exclusions.</p>
    <Code code={`# Secret scanning patterns
tether ignore add <PATTERN>
tether ignore list
tether ignore remove <PATTERN>

# Per-machine file exclusions
tether ignore dotfile <FILE>
tether ignore project <PROJECT> <PATH>
tether ignore sync-list
tether ignore sync-remove <FILE>`} />

    <h3 id="cmd-config">tether config</h3>
    <p>Manage configuration.</p>
    <Code code={`tether config get <KEY>
tether config set <KEY> <VALUE>
tether config edit
tether config dotfiles
tether config features              # List feature toggles
tether config features enable <F>   # Enable a feature
tether config features disable <F>  # Disable a feature`} />
    <ul>
      <li><code>get &lt;KEY&gt;</code> — Get config value (supports nested keys like <code>packages.brew.enabled</code>)</li>
      <li><code>set &lt;KEY&gt; &lt;VALUE&gt;</code> — Set config value</li>
      <li><code>edit</code> — Open config in editor</li>
      <li><code>dotfiles</code> — Interactive UI for managing synced files</li>
      <li><code>features</code> — Manage feature toggles (see <a href="#feature-toggles">Feature Toggles</a>)</li>
    </ul>

    <h3 id="cmd-team">tether team</h3>
    <p>Manage team sync repositories, secrets, and project sharing.</p>
    <Code code={`# Team management
tether team setup                     # Interactive wizard
tether team add <URL>                 # Add team repo
tether team list                      # List teams
tether team status                    # Show status
tether team enable/disable            # Toggle sync

# Organization mapping
tether team orgs add <ORG>            # Map GitHub org to team
tether team orgs list                 # List mapped orgs
tether team orgs remove <ORG>         # Unmap org

# Team secrets (age encryption)
tether team secrets add-recipient <KEY>   # Add member's public key
tether team secrets list-recipients       # List recipients
tether team secrets set <NAME>            # Set a secret
tether team secrets get <NAME>            # Get a secret
tether team secrets list                  # List all secrets

# Project secrets
tether team projects add <FILE>       # Share project secret
tether team projects list             # List shared secrets
tether team projects migrate          # Auto-migrate to team
tether team projects purge-personal   # Remove personal copies`} />

    <h3 id="cmd-resolve">tether resolve</h3>
    <p>Resolve file conflicts.</p>
    <Code code="tether resolve [FILE]" />
    <p>Interactive resolution: keep local, use remote, merge, or skip.</p>

    <h3 id="cmd-unlock">tether unlock</h3>
    <p>Unlock encryption key with passphrase.</p>
    <Code code="tether unlock" />

    <h3 id="cmd-lock">tether lock</h3>
    <p>Clear cached encryption key.</p>
    <Code code="tether lock" />

    <h3 id="cmd-upgrade">tether upgrade</h3>
    <p>Upgrade all installed packages across enabled package managers.</p>
    <Code code="tether upgrade" />

    <h3 id="cmd-restore">tether restore</h3>
    <p>Restore files from backup.</p>
    <Code code={`tether restore list              # List available backups
tether restore file              # Interactive restore
tether restore file --from <TS>  # Restore from specific timestamp`} />

    <h3 id="cmd-identity">tether identity</h3>
    <p>Manage age identity for team secrets encryption.</p>
    <Code code={`tether identity init     # Generate new age identity
tether identity show     # Show your public key
tether identity unlock   # Unlock with passphrase
tether identity lock     # Clear cached key
tether identity reset    # Generate new (destroys old)`} />

    <h3 id="cmd-collab">tether collab</h3>
    <p>Share project secrets with GitHub collaborators (requires write access).</p>
    <Code code={`tether collab init              # Initialize collab for current project
tether collab join <URL>        # Join existing collab
tether collab add <FILE>        # Add secret file (e.g., .env)
tether collab refresh           # Re-encrypt for current collaborators
tether collab list              # List all collabs
tether collab remove            # Remove a collab`} />
  </section>

  <hr class="my-12 border-surface" />

  <!-- Configuration -->
  <section id="configuration">
    <h2>Configuration</h2>
    <p>Configuration lives at <code>~/.tether/config.toml</code>:</p>
    <Code code={`[backend]
url = "git@github.com:username/dotfiles.git"

[security]
encrypt_dotfiles = true
scan_secrets = true

[dotfiles]
files = [".zshrc", ".gitconfig", ".vimrc"]
dirs = [".config/nvim", ".ssh/config"]

[project_configs]
enabled = true
search_paths = ["~/Projects", "~/Work"]
patterns = [".env.local", ".claude/settings.json"]

[packages.brew]
enabled = true

[packages.npm]
enabled = true

[packages.pnpm]
enabled = false

[packages.bun]
enabled = false

[packages.gem]
enabled = false`} />

    <h3>Key Configuration Options</h3>
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-surface">
          <th class="text-left py-2 pr-4">Key</th>
          <th class="text-left py-2">Description</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-b border-surface/50">
          <td class="py-2 pr-4 font-mono text-xs">backend.url</td>
          <td class="py-2">Git repository URL</td>
        </tr>
        <tr class="border-b border-surface/50">
          <td class="py-2 pr-4 font-mono text-xs">security.encrypt_dotfiles</td>
          <td class="py-2">Enable AES-256-GCM encryption</td>
        </tr>
        <tr class="border-b border-surface/50">
          <td class="py-2 pr-4 font-mono text-xs">security.scan_secrets</td>
          <td class="py-2">Enable secret detection before sync</td>
        </tr>
        <tr class="border-b border-surface/50">
          <td class="py-2 pr-4 font-mono text-xs">dotfiles.files</td>
          <td class="py-2">List of individual dotfiles to sync</td>
        </tr>
        <tr class="border-b border-surface/50">
          <td class="py-2 pr-4 font-mono text-xs">dotfiles.dirs</td>
          <td class="py-2">List of directories to sync</td>
        </tr>
        <tr class="border-b border-surface/50">
          <td class="py-2 pr-4 font-mono text-xs">project_configs.enabled</td>
          <td class="py-2">Sync project-local configs</td>
        </tr>
        <tr class="border-b border-surface/50">
          <td class="py-2 pr-4 font-mono text-xs">packages.*.enabled</td>
          <td class="py-2">Enable specific package manager sync</td>
        </tr>
      </tbody>
    </table>
  </section>

  <hr class="my-12 border-surface" />

  <!-- Feature Toggles -->
  <section id="feature-toggles">
    <h2>Feature Toggles</h2>
    <p>Control what Tether syncs with feature toggles:</p>
    <Code code={`tether config features              # List all toggles
tether config features enable <F>   # Enable a feature
tether config features disable <F>  # Disable a feature`} />

    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-surface">
          <th class="text-left py-2 pr-4">Feature</th>
          <th class="text-left py-2 pr-4">Default</th>
          <th class="text-left py-2">Description</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-b border-surface/50">
          <td class="py-2 pr-4 font-mono text-xs">personal_dotfiles</td>
          <td class="py-2 pr-4">true</td>
          <td class="py-2">Sync personal dotfiles (.zshrc, etc.)</td>
        </tr>
        <tr class="border-b border-surface/50">
          <td class="py-2 pr-4 font-mono text-xs">personal_packages</td>
          <td class="py-2 pr-4">true</td>
          <td class="py-2">Sync personal package manifests</td>
        </tr>
        <tr class="border-b border-surface/50">
          <td class="py-2 pr-4 font-mono text-xs">team_dotfiles</td>
          <td class="py-2 pr-4">false</td>
          <td class="py-2">Sync team dotfiles (requires team setup)</td>
        </tr>
        <tr class="border-b border-surface/50">
          <td class="py-2 pr-4 font-mono text-xs">collab_secrets</td>
          <td class="py-2 pr-4">false</td>
          <td class="py-2">Enable collaborator-based secret sharing</td>
        </tr>
        <tr class="border-b border-surface/50">
          <td class="py-2 pr-4 font-mono text-xs">team_layering</td>
          <td class="py-2 pr-4">false</td>
          <td class="py-2">Merge team + personal dotfiles (experimental)</td>
        </tr>
      </tbody>
    </table>

    <p class="mt-4">Example: Team-only mode (no personal sync):</p>
    <Code code={`tether config features disable personal_dotfiles
tether config features disable personal_packages
tether config features enable team_dotfiles`} />
  </section>

  <hr class="my-12 border-surface" />

  <!-- Package Managers -->
  <section id="package-managers">
    <h2>Package Managers</h2>
    <p>Tether syncs global packages across machines. Enable managers in config:</p>
    <Code code={`tether config set packages.brew.enabled true
tether config set packages.npm.enabled true`} />

    <h3>Homebrew</h3>
    <p>Syncs formulae, casks, and taps via Brewfile format. Casks include desktop apps like VS Code, Slack, Microsoft Office, and most macOS applications installed via <code>brew install --cask</code>.</p>
    <Code code={`# Manifest: manifests/Brewfile
tap "homebrew/cask"
brew "ripgrep"
brew "fd"
cask "visual-studio-code"
cask "slack"
cask "1password"`} />

    <h3>npm</h3>
    <p>Syncs global npm packages.</p>
    <Code code={`# Manifest: manifests/npm.txt
typescript
eslint
prettier`} />

    <h3>pnpm / bun / gem</h3>
    <p>Same format as npm—one package per line.</p>

    <h3>uv (Python)</h3>
    <p>Syncs global Python packages installed via <a href="https://github.com/astral-sh/uv" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">uv</a>.</p>
    <Code code={`# Enable uv sync
tether config set packages.uv.enabled true

# Manifest: manifests/uv.txt
ruff
black
mypy`} />
  </section>

  <hr class="my-12 border-surface" />

  <!-- Encryption -->
  <section id="encryption">
    <h2>Encryption & Security</h2>

    <h3>How Encryption Works</h3>
    <ol>
      <li>On first init, a random 256-bit key is generated</li>
      <li>Key is encrypted with your passphrase using <code>age</code></li>
      <li>Encrypted key is stored in the Git repo (safe to share)</li>
      <li>Dotfiles are encrypted with AES-256-GCM before commit</li>
      <li>On other machines, enter passphrase to decrypt the key</li>
    </ol>

    <h3>Secret Detection</h3>
    <p>Before syncing, Tether scans for common secret patterns:</p>
    <ul>
      <li>AWS credentials (<code>AKIA...</code>)</li>
      <li>GitHub tokens (<code>ghp_...</code>, <code>gho_...</code>)</li>
      <li>Generic patterns (<code>API_KEY=</code>, <code>password=</code>)</li>
    </ul>
    <p>Add ignore patterns for false positives:</p>
    <Code code="tether ignore add 'EXAMPLE_KEY='" />

    <h3>Unlocking</h3>
    <p>If the daemon can't decrypt (key not cached), run:</p>
    <Code code="tether unlock" />
    <p>To clear the cached key:</p>
    <Code code="tether lock" />
  </section>

  <hr class="my-12 border-surface" />

  <!-- Team Sync -->
  <section id="team-sync">
    <h2>Team Sync</h2>
    <p>Share configurations and encrypted secrets across a team.</p>

    <h3>Setup</h3>
    <Code code={`# Interactive setup wizard
tether team setup

# Or add manually
tether team add git@github.com:org/team-dotfiles.git`} />
    <p>This clones the team repo and creates symlinks to team config files.</p>

    <h3>How It Works</h3>
    <ul>
      <li>Team configs are symlinked to their target locations</li>
      <li>If you have write access, your changes sync back</li>
      <li>Read-only access means you receive updates only</li>
      <li>Auto-inject adds <code>source</code> lines to your personal dotfiles (optional)</li>
    </ul>

    <h3>Team Secrets</h3>
    <p>Share encrypted secrets using <a href="https://age-encryption.org/" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">age</a> public-key cryptography:</p>
    <Code code={`# Add your public key as a recipient
tether team secrets add-recipient age1...

# Set a secret (encrypted for all recipients)
tether team secrets set API_KEY

# Get a secret
tether team secrets get API_KEY`} />

    <h3>Organization Mapping</h3>
    <p>Map GitHub organizations to teams for automatic project secret sharing:</p>
    <Code code={`# Map org to team
tether team orgs add github.com/acme-corp

# Project secrets from that org are now shared with the team
tether team projects list`} />

    <h3>Project Secrets</h3>
    <p>Share .env files and project configs across team members:</p>
    <Code code={`# Share a project secret
tether team projects add .env

# Auto-migrate secrets from mapped orgs
tether team projects migrate

# Remove personal copies (use team version)
tether team projects purge-personal`} />

    <h3>Managing Teams</h3>
    <Code code={`tether team list          # Show all teams
tether team switch other   # Switch active team
tether team disable        # Disable without removing
tether team remove         # Remove team completely`} />
  </section>

  <hr class="my-12 border-surface" />

  <!-- Troubleshooting -->
  <section id="troubleshooting">
    <h2>Troubleshooting</h2>

    <h3>Daemon not running</h3>
    <Code code={`tether daemon start
tether daemon logs`} />

    <h3>Sync conflicts</h3>
    <Code code="tether resolve" />
    <p>Or force one direction:</p>
    <Code code="tether sync --force" />

    <h3>Encryption issues</h3>
    <Code code={`# Unlock with passphrase
tether unlock

# Check if key exists
ls ~/.tether/sync/.tether-key.age`} />

    <h3>"Secret detected" blocking sync</h3>
    <p>Either remove the secret or add an ignore pattern:</p>
    <Code code="tether ignore add 'MY_SAFE_PATTERN='" />

    <h3>Reset everything</h3>
    <Code code={`tether daemon stop
rm -rf ~/.tether
tether init`} />

    <h3>View full logs</h3>
    <Code code="cat ~/.tether/daemon.log" />
  </section>
</DocsLayout>
